<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Powerful — Content Approval (Supabase)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    /* Brand colors: #00346e, #00418b, #006fc6, #fdf9f3 */
    :root{
      --brand-1:#00346e;
      --brand-2:#00418b;
      --brand-3:#006fc6;
      --bg:#fdf9f3;
      --glass: rgba(255,255,255,0.85);
      --radius:12px;
      --frutiger: 'Frutiger', 'Frutiger Linotype', 'Helvetica Neue', Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#ffffff);font-family:var(--frutiger);color:#052036}
    header{display:flex;align-items:center;gap:16px;padding:18px;border-bottom:1px solid rgba(0,0,0,0.06);background:white}
    header img{height:48px}
    .wrap{max-width:1100px;margin:24px auto;padding:18px}

    /* Card */
    .card{background:var(--glass);padding:16px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,0.06)}

    /* Controls */
    .top-controls{display:flex;gap:8px;margin-bottom:12px}
    .inline-row{display:flex;gap:8px}
    input, textarea, button, select{font-family:var(--frutiger);font-size:14px}
    input[type=text], input[type=password], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d7e6f6}
    button{padding:10px 14px;border-radius:8px;border:0;background:var(--brand-2);color:white;cursor:pointer}
    button.secondary{background:transparent;color:var(--brand-2);border:1px solid var(--brand-2)}

    /* Admin console */
    .admin-header{display:flex;justify-content:space-between;align-items:center}
    .post-list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .post-item{padding:10px;border-radius:10px;background:white;border:1px solid rgba(0,0,0,0.04);display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px;color:#4a6b89}

    /* Viewer UI */
    .viewer-login{display:flex;flex-direction:column;gap:8px}
    .viewer-intro{background:linear-gradient(90deg,var(--brand-3),var(--brand-2));color:white;padding:12px;border-radius:8px;margin-bottom:12px}
    .headline{font-weight:700}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:60}
    .modal.open{display:flex}
    .modal .panel{width:90%;max-width:780px;background:white;padding:18px;border-radius:10px;max-height:90vh;overflow:auto}
    .media{max-width:100%;height:auto;margin-top:8px;border-radius:8px}

    /* responsive */
    @media (max-width:900px){.wrap{padding:12px}}
  </style>
</head>
<body>
  <header>
    <img src="https://www.powerful.ng/logo_with_black_BG-removebg-preview.png" alt="Powerful logo">
    <div>
      <div style="font-weight:700;font-size:18px;color:var(--brand-1)">Powerful</div>
      <div class="small">Content approval — admin & viewer consoles</div>
    </div>
  </header>

  <main class="wrap">
    <div class="top-controls">
      <button id="showAdminBtn">Admin View</button>
      <button id="showViewerBtn" class="secondary">Viewer View</button>
    </div>

    <!-- ADMIN PANEL -->
    <section class="card" id="adminPanel">
      <div class="admin-header">
        <div>
          <div style="font-weight:700;font-size:16px;color:var(--brand-1)">Admin console</div>
          <div class="small">Sign in to manage posts (password required)</div>
        </div>
        <div class="small">Admin pwd: <strong>powerful</strong></div>
      </div>

      <div id="adminAuth" style="margin-top:12px">
        <div class="inline-row">
          <input type="password" id="adminPwd" placeholder="Enter admin password">
          <button id="adminLoginBtn">Sign in</button>
        </div>
        <div class="small" style="margin-top:8px;color:#7b96b0">After signing in you can create, edit, delete posts and set viewer access code & password.</div>
      </div>

      <div id="adminPanelArea" style="display:none;margin-top:12px">
        <div style="display:grid;grid-template-columns:1fr 260px;gap:12px;align-items:start">
          <div>
            <label class="small">Post header</label>
            <input id="postHeader" type="text" placeholder="Short headline or copy">
            <label class="small" style="margin-top:8px">Body</label>
            <textarea id="postBody" rows="4" placeholder="Longer post copy / details"></textarea>
            <label class="small" style="margin-top:8px">Image or video link (embed URL)</label>
            <input id="postMedia" type="text" placeholder="https://... (image or video)" />

            <div style="margin-top:10px;display:flex;gap:8px">
              <button id="createPostBtn">Create post</button>
              <button class="secondary" id="clearFormBtn">Clear</button>
            </div>
          </div>

          <div class="card" style="background:#fffefc;padding:12px">
            <div style="font-weight:700;margin-bottom:8px">Viewer access control</div>
            <label class="small">Access code (required for viewers)</label>
            <input id="accessCodeInput" type="text" placeholder="Set code viewers must supply">
            <div style="margin-top:8px;display:flex;gap:8px"><button id="saveAccessBtn">Save</button><button class="secondary" id="generateCodeBtn">Generate</button></div>
            <div class="small" style="margin-top:10px;color:#436">Current code: <span id="currentCode">—</span></div>
          </div>
        </div>

        <hr style="margin:16px 0;border:none;border-top:1px solid #eef4fb">

        <div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Posts</div>
            <div class="small">You will see approvals and comments here</div>
          </div>
          <div id="postsContainer" class="post-list"></div>
        </div>
      </div>
    </section>

    <!-- VIEWER PANEL -->
    <section class="card" id="viewerPanel" style="display:none;margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700;font-size:16px;color:var(--brand-1)">Viewer console</div>
          <div class="small">Sign in with the code provided by your content manager</div>
        </div>
        <img src="https://www.powerful.ng/logo_with_black_BG-removebg-preview.png" alt="Powerful" style="height:36px">
      </div>

      <div id="viewerAuthArea" style="margin-top:12px">
        <div class="viewer-login">
          <label class="small">Type in the code password provided by your content manager</label>
          <input id="viewerCode" type="text" placeholder="Access code">
          <div style="display:flex;gap:8px"><button id="viewerSignInBtn">Sign in</button><button class="secondary" id="viewerSignOutBtn" style="display:none">Sign out</button></div>
          <div class="small" style="margin-top:8px;color:#6b7d92">Note: you remain anonymous. Your actions (approve/reject/comments) will be recorded but your identity is not stored.</div>
        </div>
      </div>

      <div id="viewerArea" style="display:none;margin-top:12px">
        <div class="viewer-intro">
          <div style="font-weight:700">Welcome</div>
          <div style="margin-top:6px">You can approve, reject and add comments to posts to help us improve. Click any headline to read the full post and respond.</div>
        </div>

        <div id="viewerPosts" class="post-list"></div>
      </div>
    </section>
  </main>

  <!-- Modal for post view -->
  <div id="modal" class="modal">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="modalHeader" style="font-weight:700;font-size:18px"></div>
          <div id="modalSub" class="small" style="margin-top:6px;color:#556">Post details</div>
        </div>
        <div><button class="secondary" id="closeModalBtn">Close</button></div>
      </div>

      <div id="modalBody" style="margin-top:12px"></div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="approveBtn">Approve</button>
        <button class="secondary" id="rejectBtn">Reject</button>
        <div style="flex:1"></div>
      </div>

      <div style="margin-top:12px">
        <label class="small">Add a short note (optional)</label>
        <textarea id="modalComment" rows="3" placeholder="Your feedback to the content manager"></textarea>
        <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="sendResponseBtn">Send response</button></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded',async ()=>{
      /* Supabase-backed app (no user auth). */
      const SUPABASE_URL = 'https://xgdjgxgodwxtpjxkcpaf.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnZGpneGdvZHd4dHBqeGtjcGFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NDMwNTYsImV4cCI6MjA4MDMxOTA1Nn0.lTPmOW2ZxlwSv1yiJkIvdK4bEsWH2dC71bjN7WMbJpM';
      const { createClient } = supabase;
      const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

      const ADMIN_PWD = 'powerful';

      // Utilities
      function qs(id){return document.getElementById(id)}

      // DOM refs
      const adminLoginBtn = qs('adminLoginBtn');
      const adminPwd = qs('adminPwd');
      const adminPanelArea = qs('adminPanelArea');
      const postsContainer = qs('postsContainer');
      const createPostBtn = qs('createPostBtn');
      const clearFormBtn = qs('clearFormBtn');
      const postHeader = qs('postHeader');
      const postBody = qs('postBody');
      const postMedia = qs('postMedia');
      const accessCodeInput = qs('accessCodeInput');
      const saveAccessBtn = qs('saveAccessBtn');
      const generateCodeBtn = qs('generateCodeBtn');
      const currentCodeSpan = qs('currentCode');

      const viewerSignInBtn = qs('viewerSignInBtn');
      const viewerSignOutBtn = qs('viewerSignOutBtn');
      const viewerCode = qs('viewerCode');
      const viewerArea = qs('viewerArea');
      const viewerPosts = qs('viewerPosts');
      const viewerAuthArea = qs('viewerAuthArea');

      const modal = qs('modal');
      const modalHeader = qs('modalHeader');
      const modalBody = qs('modalBody');
      const closeModalBtn = qs('closeModalBtn');
      const approveBtn = qs('approveBtn');
      const rejectBtn = qs('rejectBtn');
      const sendResponseBtn = qs('sendResponseBtn');
      const modalComment = qs('modalComment');

      const showAdminBtn = qs('showAdminBtn');
      const showViewerBtn = qs('showViewerBtn');
      const adminPanel = qs('adminPanel');
      const viewerPanel = qs('viewerPanel');

      // App state
      let posts = [];
      let settings = { accessCode: 'user' };
      let currentEditId = null;
      let viewerSession = null; // {anonId, code}

      // Small helper to show alerts
      function notify(msg){alert(msg)}

      // Load settings from DB (config table id=1)
      async function loadSettings(){
        try{
          const { data, error } = await sb.from('config').select('viewer_code').eq('id',1).single();
          if(error && error.code !== 'PGRST116') console.warn('loadSettings error',error);
          settings.accessCode = data && data.viewer_code ? data.viewer_code : 'user';
          if(currentCodeSpan) currentCodeSpan.textContent = settings.accessCode;
        }catch(e){console.error(e)}
      }

      // Save access code to DB
      async function saveAccess(code){
        try{
          const { data, error } = await sb.from('config').upsert({id:1, viewer_code: code}, { returning: 'minimal' });
          if(error) {console.error('saveAccess error', error); notify('Failed to save access code')}
          else{ settings.accessCode = code; if(currentCodeSpan) currentCodeSpan.textContent = code; notify('Saved') }
        }catch(e){console.error(e);notify('Failed to save')}
      }

      // Load posts from DB
      async function loadPosts(){
        try{
          const { data, error } = await sb.from('posts').select('*').order('createdAt', { ascending: false });
          if(error) { console.error('loadPosts error',error); posts = []; return }
          // Map DB columns to app model
          posts = (data||[]).map(r=>({ id: r.id, header: r.heading, body: r.text, media: r.medialink, status: r.status, comment: r.comment, createdAt: r.createdAt }));
        }catch(e){console.error(e);posts=[]}
      }

      // Create post
      async function createPost(){
        const header = (postHeader.value||'').trim();
        const body = (postBody.value||'').trim();
        const media = (postMedia.value||'').trim();
        if(!header || !body){notify('Header and body are required');return}
        try{
          const { error } = await sb.from('posts').insert({ heading: header, text: body, medialink: media });
          if(error) { console.error('createPost error',error); notify('Failed to create post'); return }
          postHeader.value='';postBody.value='';postMedia.value='';
          await loadPosts(); renderAdminPosts(); renderViewerList();
        }catch(e){console.error(e);notify('Failed')}
      }

      // Update post
      async function updatePost(id){
        const header = (postHeader.value||'').trim();
        const body = (postBody.value||'').trim();
        const media = (postMedia.value||'').trim();
        if(!header || !body){notify('Header and body are required');return}
        try{
          const { error } = await sb.from('posts').update({ heading: header, text: body, medialink: media }).eq('id', id);
          if(error){console.error('updatePost error',error);notify('Failed to update');return}
          currentEditId = null; if(createPostBtn) createPostBtn.textContent='Create post';
          postHeader.value='';postBody.value='';postMedia.value='';
          await loadPosts(); renderAdminPosts(); renderViewerList();
        }catch(e){console.error(e);notify('Failed')}
      }

      // Delete post
      async function deletePost(id){
        if(!confirm('Delete this post?')) return;
        try{
          const { error } = await sb.from('posts').delete().eq('id', id);
          if(error){console.error('deletePost error',error);notify('Failed to delete');return}
          await loadPosts(); renderAdminPosts(); renderViewerList();
        }catch(e){console.error(e);notify('Failed')}
      }

      // Admin render
      function renderAdminPosts(){
        if(!postsContainer) return;
        postsContainer.innerHTML='';
        if(posts.length===0){postsContainer.innerHTML='<div class="small">No posts yet</div>';return}
        posts.forEach(p=>{
          const div=document.createElement('div');div.className='post-item';
          const left=document.createElement('div');
          left.innerHTML=`<div style="font-weight:700">${escapeHtml(p.header)}</div><div class="small">${escapeHtml((p.body||'')).slice(0,120)}${(p.body||'').length>120?'...':''}</div><div class="small">Status: ${p.status||'Pending'}</div>`;
          const right=document.createElement('div');
          const stats=`<div class="small">Comments: ${p.comment ? p.comment.split('\n').length : 0}</div>`;
          right.innerHTML = stats + '<div style="margin-top:8px;display:flex;gap:6px"><button data-id="'+p.id+'" class="editBtn">Edit</button><button class="secondary" data-id="'+p.id+'">Delete</button></div>';
          div.appendChild(left);div.appendChild(right);postsContainer.appendChild(div);
        });
        // attach handlers
        postsContainer.querySelectorAll('button[data-id]').forEach(b=>{
          b.addEventListener('click',()=>{
            const id = b.getAttribute('data-id');
            if(b.textContent==='Edit') startEdit(id);
            else deletePost(id);
          });
        });
      }

      // Viewer render
      function renderViewerList(){
        if(!viewerPosts) return;
        viewerPosts.innerHTML='';
        if(posts.length===0){viewerPosts.innerHTML='<div class="small">No posts available</div>';return}
        posts.forEach(p=>{
          const div=document.createElement('div');div.className='post-item';
          div.innerHTML=`<div style="flex:1"><div class="headline">${escapeHtml(p.header)}</div><div class="small">${escapeHtml((p.body||'')).slice(0,80)}${(p.body||'').length>80?'...':''}</div><div class="small">Status: ${p.status||'Pending'}</div></div>`;
          div.addEventListener('click',()=>openModal(p.id));
          viewerPosts.appendChild(div);
        });
      }

      // Start edit
      function startEdit(id){
        const p = posts.find(x=>x.id===id); if(!p) return;
        postHeader.value = p.header || '';
        postBody.value = p.body || '';
        postMedia.value = p.media || '';
        currentEditId = id; if(createPostBtn) createPostBtn.textContent='Save changes'; window.scrollTo({top:0,behavior:'smooth'});
      }

      // Modal open
      function openModal(id){
        const p = posts.find(x=>x.id===id); if(!p) return;
        if(modalHeader) modalHeader.textContent = p.header;
        if(modalBody) {
          modalBody.innerHTML = `<div style="white-space:pre-line">${escapeHtml(p.body||'')}</div>`;
          if(p.media){
            if(p.media.match(/\.(jpg|jpeg|png|gif|webp)$/i) || p.media.includes('image')){
              modalBody.innerHTML += `<img src="${escapeHtmlAttr(p.media)}" class="media">`;
            } else {
              modalBody.innerHTML += `<div style="margin-top:10px"><a href="${escapeHtmlAttr(p.media)}" target="_blank">Open media</a></div>`;
            }
          }
          modalBody.innerHTML += `<div style="margin-top:10px" class="small">Status: ${p.status||'Pending'}</div>`;
          modalBody.innerHTML += `<div style="margin-top:8px" class="small">${escapeHtml(p.comment||'')}</div>`;
        }
        if(modal){ modal.dataset.postId = id; modal.classList.add('open'); }
      }
      if(closeModalBtn) closeModalBtn.addEventListener('click',()=>{ if(modal) modal.classList.remove('open'); if(modalComment) modalComment.value=''; });

      // Record response: set status and append comment to comment field
      async function recordResponse(action){
        const id = modal && modal.dataset.postId; const p = posts.find(x=>x.id===id); if(!p) return;
        if(!viewerSession){notify('You must sign in as a viewer to respond');return}
        const note = (modalComment && modalComment.value.trim()) || '';
        const newStatus = action==='approve' ? 'Approved' : (action==='reject' ? 'Disapproved' : p.status || 'Pending');
        const time = new Date().toISOString();
        const entry = `${time} | ${viewerSession.anonId} | ${action} | ${note}`;
        const combined = (p.comment ? p.comment + '\n' : '') + entry;
        try{
          const { error } = await sb.from('posts').update({ status: newStatus, comment: combined }).eq('id', id);
          if(error){console.error('recordResponse error',error);notify('Failed to save response');return}
          await loadPosts(); renderAdminPosts(); renderViewerList(); if(modal) modal.classList.remove('open'); if(modalComment) modalComment.value=''; notify('Response recorded');
        }catch(e){console.error(e);notify('Failed')}
      }

      if(approveBtn) approveBtn.addEventListener('click',()=>recordResponse('approve'));
      if(rejectBtn) rejectBtn.addEventListener('click',()=>recordResponse('reject'));
      if(sendResponseBtn) sendResponseBtn.addEventListener('click',()=>recordResponse('comment'));

      // Admin login
      if(adminLoginBtn) adminLoginBtn.addEventListener('click',async ()=>{
        if(adminPwd.value===ADMIN_PWD){
          qs('adminAuth').style.display='none'; adminPanelArea.style.display='block';
          await loadSettings(); await loadPosts(); renderAdminPosts(); renderViewerList();
        } else notify('Invalid admin password');
      });

      // Create / update post
      if(createPostBtn) createPostBtn.addEventListener('click',async ()=>{
        if(currentEditId) await updatePost(currentEditId); else await createPost();
      });
      if(clearFormBtn) clearFormBtn.addEventListener('click',()=>{ postHeader.value=''; postBody.value=''; postMedia.value=''; currentEditId=null; if(createPostBtn) createPostBtn.textContent='Create post'; });

      // Access code control
      if(saveAccessBtn) saveAccessBtn.addEventListener('click',()=>{ const code = (accessCodeInput.value||'').trim(); if(!code) return notify('Access code cannot be empty'); saveAccess(code); });
      if(generateCodeBtn) generateCodeBtn.addEventListener('click',()=>{ const code = 'P-'+Math.random().toString(36).slice(2,8).toUpperCase(); accessCodeInput.value = code; });

      // Viewer sign in (only access code required)
      if(viewerSignInBtn) viewerSignInBtn.addEventListener('click',async ()=>{
        const code = (viewerCode.value||'').trim();
        await loadSettings();
        if(!settings.accessCode){notify('No access code set by admin');return}
        if(code !== settings.accessCode){notify('Invalid code');return}
        viewerSession = { code, anonId: 'anon-'+Math.random().toString(36).slice(2,9) };
        if(viewerAuthArea) viewerAuthArea.style.display='none'; if(viewerArea) viewerArea.style.display='block'; if(viewerSignOutBtn) viewerSignOutBtn.style.display='inline-block';
        await loadPosts(); renderViewerList();
      });
      if(viewerSignOutBtn) viewerSignOutBtn.addEventListener('click',()=>{ viewerSession=null; if(viewerAuthArea) viewerAuthArea.style.display='block'; if(viewerArea) viewerArea.style.display='none'; if(viewerSignOutBtn) viewerSignOutBtn.style.display='none'; if(viewerCode) viewerCode.value=''; });

      // UI toggle
      if(showAdminBtn) showAdminBtn.addEventListener('click',()=>{ adminPanel.style.display='block'; viewerPanel.style.display='none'; });
      if(showViewerBtn) showViewerBtn.addEventListener('click',()=>{ adminPanel.style.display='none'; viewerPanel.style.display='block'; });

      // Initial load
      await loadSettings(); await loadPosts(); renderAdminPosts(); renderViewerList();

      // Admin double-click for details
      if(postsContainer) postsContainer.addEventListener('dblclick',e=>{
        const item = e.target.closest('.post-item'); if(!item) return; const header = item.querySelector('div').innerText.split('\n')[0]; const p = posts.find(x=>x.header===header); if(p){ const comments = (p.comment||'').split('\n').join('\n'); alert(`Post: ${p.header}\n\nBody:\n${p.body}\n\nStatus: ${p.status||'Pending'}\n\nComments:\n${comments||'No comments'}`); }
      });

      // Helpers
      function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
      function escapeHtmlAttr(s){return String(s||'').replace(/"/g,'%22').replace(/'/g,'%27');}

    });
  </script>
</body>
</html>
